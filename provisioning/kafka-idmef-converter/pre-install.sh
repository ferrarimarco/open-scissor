#!/bin/bash

set -xeuo pipefail
IFS=$'\\n\t'

yum install -y epel-release

yum clean all
rm -rf /var/cache/yum

P12FILE="/root/assystem-prelude.p12"
PRIVATE_KEY="/root/assystem-prelude.priv.pem"
PUBLIC_KEY="/root/assystem-prelude.pub.pem"
PASSWORD="48c9AyFfU8"

PRELUDE_GPG_KEY="/root/RPM-GPG-KEY-Prelude-IDS"

base64 -d <<EOF > ${P12FILE}
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
AA==
EOF

openssl pkcs12 -in ${P12FILE} -clcerts -nodes -nocerts -passin pass:${PASSWORD} | openssl rsa > ${PRIVATE_KEY}
openssl pkcs12 -in ${P12FILE} -clcerts -nokeys -passin pass:${PASSWORD} | openssl x509 > ${PUBLIC_KEY}

cat <<EOF > /etc/yum.repos.d/release.prelude-siem.com_assystem_pkgs_centos_7_.repo
[release.prelude-siem.com_assystem_pkgs_centos_7_]
name=added from: https://release.prelude-siem.com/assystem/pkgs/centos/7/
baseurl=https://assystem:${PASSWORD}@release.prelude-siem.com/assystem/pkgs/centos/7/
enabled=1
sslverify=0
sslclientcert=/root/assystem-prelude.pub.pem
sslclientkey=/root/assystem-prelude.priv.pem
EOF

cat << EOF > ${PRELUDE_GPG_KEY}
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v2.0.14 (GNU/Linux)

mQGiBE/R25ERBADEyDMws7lO01nlE+eefOWrCtezQu1yBx+UuM1m4jOZZVrmanDS
zjK1gPqfthopUr8u7YZb3F71iGchMwFZFL4BGCoXjTvB76KVmcqppUQjDfRMW2d1
F0CazairAM2POYiYGzAqD1ZjVxtyayhXV/gXDLQdrWIJC7NOqIKeL+zlzwCg+AES
j9o4QLqEiWURtiFpqJ1d4CsD/1jffzqynSUHQvkNW7JmFVYdayp4VZ9PC+GP9UBH
d59IASh6tvqNUuC6Z9bwQaIeWGM51SAUE4bZJOubrL0pJuCUs5lYMU3o6Ry8Kya2
VFr0+p/7UGqCHjtHNO0TjIO0hA/KEGyeZ5xoW6/1dOZImoyT2AkSXg2iqCoQQ9IE
Gz2JA/0cBFrJ81YdkohtZS8f+qZ2b1QPXGM6ohCgA+wtWbqq/Y65AgMu74LVs5cU
vGGrugZJKhzmOMfJlUVVtlbCR2DpdR40vLu+6hywg18sGkalRRUlNzXMk8/9EwGB
tfNTTvsmhs5lKtcxS+zTXKNpWZyVBUtUHTCN872J6Z6/Euhe47QzUFJFTFVERSAo
UmVsZWFzZSBNYW5hZ2VyKSA8Y29udGFjdEBwcmVsdWRlLWlkcy5vcmc+iGIEExEC
ACIFAk/R25ECGwMGCwkIBwMCBhUIAgkKCwQWAgMBAh4BAheAAAoJEDXowMOzZRiY
qm8AoK7pz7qvV9b1YVh4sOEzUEx2tTjbAJ906X+AN1qF48WPyFE+JmkyqKLm0LkB
DQRP0duREAQA5REDx5bx6asyYTXGL6VjSDa9DwIhDwXvmyE6zO/I8i8EGrdFb6zn
XGzT06lVnMoH94OK8aOwgzDOBCtNSfc7+XyAj69VV08sEnr3U7BSN6TKts6SFVaI
5j6dnnquDVmiF0S8KFODHQyxE0NKP9y4uR7EtX9swZv9gVPvVlyBxQ8AAwUD/A2I
d5YDihKz62FBEGVIgz3ZN+I1ZXtDhfoVVRXa89DTDsXXCSd3IUyXxGDM1mYwj7Dm
KpG2Z5ZrULovoQsmdTkdfB3g+oDh3HoKjPiSEAM7tiDo37W5iYkBBiUdw9xCLG2X
POuGRKfP2cpgp8ACvHQkcrRJwdUwK0B+7Oih8vbFiEkEGBECAAkFAk/R25ECGwwA
CgkQNejAw7NlGJjDsgCg93tK1pZ0wvaGvpzTnazp4aDGFQcAn1LaS086WZRZgDRZ
RvZrLThRCzMo
=3ML2
-----END PGP PUBLIC KEY BLOCK-----
EOF

rpm --import ${PRELUDE_GPG_KEY}

# blacklist prelude packages from epel (quotes around EOF prevent variable substitution)
cat << "EOF" > /etc/yum.repos.d/epel.repo
[epel]
name=Extra Packages for Enterprise Linux 7 - $basearch
#baseurl=http://download.fedoraproject.org/pub/epel/7/$basearch
mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-7&arch=$basearch
failovermethod=priority
enabled=1
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7
exclude=prelude* libprelude*

[epel-debuginfo]
name=Extra Packages for Enterprise Linux 7 - $basearch - Debug
#baseurl=http://download.fedoraproject.org/pub/epel/7/$basearch/debug
mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-debug-7&arch=$basearch
failovermethod=priority
enabled=0
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7
gpgcheck=1

[epel-source]
name=Extra Packages for Enterprise Linux 7 - $basearch - Source
#baseurl=http://download.fedoraproject.org/pub/epel/7/SRPMS
mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-source-7&arch=$basearch
failovermethod=priority
enabled=0
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7
gpgcheck=1
EOF

cat << "EOF" > /etc/yum.repos.d/scissor.repo
[SCISSOR]
name=SCISSOR
baseurl=https://yum.sixsq.com/scissor/yum
enabled=1
protect=0
gpgcheck=0
metadata_expire=300s
autorefresh=1
type=rpm-md
sslverify=0
EOF
